<html layout:decorate="~{layouts/layout}">
<main layout:fragment="content" class="container my-3">
    <h2 class="border-bottom py-2" th:text="${board.title}"></h2>
    <div class="card my-3">
        <div class="card-body">
            <div class="card-text" style="white-space: pre-line;" th:text="${board.content}"></div>
            <div class="mb-3" th:if="${board.imageUrls.size() > 0}">
                <label class="form-label">Images</label>
                <div>
                    <th:block th:each="imageUrl : ${board.imageUrls}">
                        <img th:src="${imageUrl}" alt="Image" width="200px" height="200px">
                    </th:block>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <div class="badge bg-light text-dark p-2 text-start">
                    <div th:if="${board.users != null}">
                        작성자 :
                        <img th:if="${board.users != null}" class="d-flex mr-3 rounded-circle"
                             th:src="${board.users.getImage().getUrl()}"
                             alt="User image" width="50">
                        [[${board.nickname}]]
                    </div>
                    <div th:if="${(board.users == null) and (board.delete_user_nickname != null)}">
                        작성자 : [[${board.nickname}]] (소프트삭제유저)
                    </div>
                    <div th:if="${(board.users == null) and (board.delete_user_nickname == null)}">
                        작성자 : [[${board.nickname}]] (하드삭제유저)
                    </div>
                    <div>
                        작성시간 : [[${#temporals.format(board.createDate, 'yyyy-MM-dd HH:mm')}]]
                    </div>
                    <div th:if="${board.modifyDate != null}">
                        수정시간 :  [[${#temporals.format(board.modifyDate, 'yyyy-MM-dd HH:mm')}]]
                    </div>
                    <div>
                        조회수 : [[${board.views}]]
                    </div>
                </div>
            </div>
        </div>

        <div class="my-3">
            <!-- 로그인 하지 않은 경우 기존꺼 그대로 노출-->
            <a sec:authorize="isAnonymous()" class="btn btn-sm btn-outline-secondary" th:href="@{/users/login}">
                추천(로그인필요)
                <span class="badge rounded-pill bg-success" th:text="${#sets.size(board.voters)}"></span>
            </a>
            <a sec:authorize="isAnonymous()" class="btn btn-sm btn-outline-secondary" th:href="@{/users/login}">
                비추천(로그인필요)
                <span class="badge rounded-pill bg-success" th:text="${#sets.size(board.notvoters)}"></span>
            </a>

            <!-- 로그인한 경우 -->
            <form sec:authorize="isAuthenticated()" th:if="${hasBoardVoted and !hasBoardNotVoted}" th:action="@{|/board/vote/${board.id}|}" method="post">
                <button type="submit" onclick="return confirm('추천을 취소하시겠습니까?');" class="btn btn-sm active btn-outline-secondary">
                    추천
                    <span class="badge rounded-pill bg-success" th:text="${#sets.size(board.voters)}"></span>
                </button>
            </form>
            <form sec:authorize="isAuthenticated()" th:if="${!hasBoardVoted and !hasBoardNotVoted}" th:action="@{|/board/vote/${board.id}|}" method="post">
                <button type="submit" onclick="return confirm('추천하시겠습니까?');" class="recommend btn btn-sm btn-outline-secondary">
                    추천
                    <span class="badge rounded-pill bg-success" th:text="${#sets.size(board.voters)}"></span>
                </button>
            </form>
            <form sec:authorize="isAuthenticated()" th:if="${!hasBoardVoted and hasBoardNotVoted}" th:action="@{|/board/vote/${board.id}|}" method="post">
                <button type="submit" onclick="return alert('비추천을 줘서 추천할 수 없습니다');" class="recommend btn btn-sm btn-outline-secondary">
                    추천
                    <span class="badge rounded-pill bg-success" th:text="${#sets.size(board.voters)}"></span>
                </button>
            </form>

            <form sec:authorize="isAuthenticated()" th:if="${hasBoardNotVoted and !hasBoardVoted}" th:action="@{|/board/notvote/${board.id}|}" method="post">
                <button type="submit" onclick="return confirm('비추천을 취소하시겠습니까?');" class="btn btn-sm active btn-outline-secondary">
                    비추천
                    <span class="badge rounded-pill bg-success" th:text="${#sets.size(board.notvoters)}"></span>
                </button>
            </form>
            <form sec:authorize="isAuthenticated()" th:if="${!hasBoardNotVoted and !hasBoardVoted}" th:action="@{|/board/notvote/${board.id}|}" method="post">
                <button type="submit" onclick="return confirm('비추천하시겠습니까?');" class="recommend btn btn-sm btn-outline-secondary">
                    비추천
                    <span class="badge rounded-pill bg-success" th:text="${#sets.size(board.notvoters)}"></span>
                </button>
            </form>
            <form sec:authorize="isAuthenticated()" th:if="${!hasBoardNotVoted and hasBoardVoted }" th:action="@{|/board/notvote/${board.id}|}" method="post">
                <button type="submit" onclick="return alert('추천을 줘서 비추천을 취소할 수 없습니다');" class="recommend btn btn-sm btn-outline-secondary">
                    비추천
                    <span class="badge rounded-pill bg-success" th:text="${#sets.size(board.notvoters)}"></span>
                </button>
            </form>
            <br>
            <a th:href="@{|/board/modify/${board.id}|}" class="btn btn-sm btn-outline-secondary">수정하기</a>
            <a href="javascript:void(0);" th:data-uri="@{|/board/delete/${board.id}|}"
               class="delete btn btn-sm btn-outline-secondary"
               th:text="삭제"></a>
            <button class="btn btn-primary" data-bs-toggle="collapse" data-bs-target="#collapseExample"
                    aria-expanded="false" aria-controls="collapseExample">
                추천자 확인
            </button>
            <div class="collapse" id="collapseExample">
                <div class="card card-body">
                    <h4>추천 명단</h4>
                    <div th:each="voter : ${voterNickname}">
                        <div class="card card-body">
                            <h6 th:text="${voter}"></h6>
                        </div>
                    </div>
                    <h4>비추천 명단</h4>
                    <div th:each=" voter : ${notvoterNickname}">
                        <div class="card card-body">
                            <h6 th:text="${voter}"></h6>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="panel panel-default">
            <div class="panel-heading" role="tab">
                <a role="button" data-toggle="collapse" data-parent="#accParent" data-target="#accEx2" aria-constrols="addEx2">
                    추천자 확인
                </a>
            </div>
            <div id="accEx2" class="panel-collapse collapse" role="tabpanel">
                <div class="panel-body">
                    <div class="card card-body">
                        <h4>추천 명단</h4>
                        <div th:each="voter : ${voterNickname}">
                            <div class="card card-body">
                                <h6 th:text="${voter}"></h6>
                            </div>
                        </div>
                        <h4>비추천 명단</h4>
                        <div th:each=" voter : ${notvoterNickname}">
                            <div class="card card-body">
                                <h6 th:text="${voter}"></h6>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>



     <!-- 댓글 작성 부분 -->
    <div id="write" class="d-flex flex-column gap-2 card-body bg-white rounded shadow-lg gap-2" style="margin : 10px">
        <div class="d-flex justify-content-left">
            <div class="label d-flex" style="cursor:pointer;">
                <label class="label gap-2 form-check form-switch">
                    <input type="checkbox" name="secret" id="secret" class="form-check-input"/>
                    <i class="fa-solid fa-lock"></i>
                    <span class="label-text font-semibold">비밀댓글</span>
                </label>
            </div>
        </div>
        <div class="d-flex">
            <input type="hidden" id="boardId" th:value="${board.id}">
            <textarea sec:authorize="isAuthenticated()" name="content" placeholder="댓글을 입력해주세요." id="content"
                      style="height: 50px"
                      class="border border-gray-300 flex-grow-1"></textarea>
            <textarea sec:authorize="isAnonymous()" disabled placeholder="로그인 후 댓글 작성이 가능합니다."
                      style="height: 50px"
                      class="border border-gray-300 rounded-lg textarea-lg w-full
                focus:outline-none focus:ring-2 focus:ring-blue-400 flex-grow-1"></textarea>
            첨부파일 : <input type="file" id="comment-file"> <br><br>
            <button sec:authorize="isAuthenticated()" class="btn btn-primary" onclick="CommentSave()">댓글 등록</button>
            <a href="/users/login" sec:authorize="isAnonymous()" class="btn btn-primary">댓글 등록</a>

        </div>
    </div>


    <!-- 댓글 개수 갱신용 -->
    <div class="d-flex justify-content-between align-items-baseline">
        <div id="new_total_board_comments" th:if="${totalCount !=null}" th:text="|댓글 개수 :${totalCount}|"></div>
        <div th:if="${totalCount ==null}" th:text="${totalCount}">0</div>
        <div>
            <ul class="nav d-flex align-items-baseline gap-2">
                <span>정렬 기준</span>
                <li class="nav-item">
                    <a class="nav-link btn btn-primary text-white" th:classappend="${#strings.equals(param.sort, 'createDate')} ? 'active'" th:href="@{|?sort=createDate&page=${boardCommentPaging.number}|}">최신순</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link btn btn-primary text-white" th:classappend="${#strings.equals(param.sort, 'recommends')} ? 'active'" th:href="@{|?sort=recommends&page=${boardCommentPaging.number}|}">추천순</a>
                </li>
            </ul>
        </div>
    </div>

    <h4 th:if="${commentTop != null}"> 베스트 댓글 탑3</h4>
    <div class="nav-link d-flex flex-column gap-2" th:each="commentVoter : ${commentTop}">
        <div class="card-body bg-white rounded shadow-lg"
             th:if="${#sets.size(commentVoter.recommends) > 0}
                       and
                    (${#sets.size(commentVoter.recommends)} >= ${#sets.size(commentVoter.notRecommends)})">
            <div th:if="${commentVoter.imageUrl != null}">
                <img class="d-flex mr-3 rounded-circle" th:src="${commentVoter.imageUrl}" alt="User image" width="50">
            </div>
            <div class="d-flex align-items-baseline gap-2" >
                <p th:if="${commentVoter.nickname !=null}"
                        th:text="${commentVoter.nickname}" class="text-primary"></p>
                <p th:if="${commentVoter.delete_user_nickname !=null }"
                    th:text="${commentVoter.delete_user_nickname}">
                </p>
                <p th:if="${(commentVoter.nickname ==null) and (commentVoter.delete_user_nickname ==null)}">
                   완전 탈퇴한 유저입니다.
                </p>
            </div>
            <div th:if="${!commentVoter.deleted}">
                <p class="text-lg font-bold"
                   th:text="${commentVoter.content}" style="white-space: pre-wrap;" ></p>
                <a class="btn btn-sm btn-outline-secondary">
                    추천
                    <span class="badge rounded-pill bg-success" th:text="${#sets.size(commentVoter.recommends)}"></span>
                </a>
            </div>
            <div th:if="${!commentVoter.deleted}">
                <a class="btn btn-sm btn-outline-secondary">
                    비추천
                    <span class="badge rounded-pill bg-success" th:text="${#sets.size(commentVoter.notRecommends)}"></span>
                </a>
            </div>
        </div>
    </div>

    <!-- 댓글 목록 -->
    <h4>댓글 목록</h4>
    <div class="nav-link d-flex flex-column gap-2" th:each="comment : ${boardCommentPaging}">
        <div class="card-body bg-white rounded shadow-lg" th:if="${comment.parent == null}">
            <div class="card-body bg-white rounded shadow-lg" >
                <a th:id="|board_comment_${comment.id}|"></a>
                <div th:if="${comment.imageUrl != null}">
                    <img class="d-flex mr-3 rounded-circle" th:src="${comment.imageUrl}" alt="User image" width="50">
                </div>
                <div class="d-flex align-items-baseline gap-2">
                    <p th:text="${comment.nickname}" class="text-primary"></p>
                    <!-- 비밀댓글 표시 자물쇠-->
                    <span class="badge text-bg-success" th:if="${comment.secret}">
                          <i class="fa-solid fa-lock" style="color: #ffffff;"></i>
                    </span>
                </div>
                <div class="d-flex justify-content-between">
                    <p class="text-body-tertiary" th:if="${comment.deleted}"> 삭제된 댓글입니다.</p>
                    <div th:if="${!comment.secret}">
                        <div th:if="${comment.commentImage != null}">
                            <img th:src="${comment.commentImage.getUrl()}" alt="Image" width="200px" height="200px">
                        </div>
                        <p th:if="${(comment.deleted == false)}"
                                th:text="${comment.content}" style="white-space: pre-wrap;"></p>
                    </div>
                    <div th:if="${comment.secret and !comment.deleted}">
                        <div sec:authorize="isAuthenticated()">
                            <p class="text-lg font-bold" th:if="${(comment.username ==
                            #authentication.getPrincipal().getUsername())
                        or (board.username == #authentication.getPrincipal().getUsername()) or
                        (#authentication.getPrincipal().getUsername() eq 'admin')}"
                               th:text="${comment.content}" style="white-space: pre-wrap;" ></p>
                            <p class="text-lg font-bold"
                               th:if="${!((comment.username ==
                            #authentication.getPrincipal().getUsername()) or
                            (board.username == #authentication.getPrincipal().getUsername())
                             or (#authentication.principal.username eq 'admin'))}">
                                비밀 댓글입니다.</p>
                        </div>
                        <div sec:authorize="isAnonymous()">
                            <p class="text-lg font-bold" th:if="${comment.secret}">
                                비밀 댓글입니다.</p>
                        </div>
                    </div>
                    <div class="gap-3">
                        <div class="badge bg-light text-dark p-2 text-start gap-3">
                            작성일
                            <div th:text="${#temporals.format(comment.createDate, 'yyyy-MM-dd HH:mm')}"></div>
                        </div>
                        <div th:if="${comment.modifyDate != null}" class="badge bg-light text-dark p-2 text-start gap-3">
                            <i class="fa-solid fa-clock-rotate-left"></i>
                            수정일
                            <div th:text="${#temporals.format(comment.modifyDate, 'yyyy-MM-dd HH:mm')}"></div>
                        </div>
                    </div>
                </div>
                <!-- 삭제 할 댓글 id와 작성자 정보 저장 용-->
                <input type="hidden" th:id="'comment-' + ${comment.id}" th:value="${comment.id}"/>
                <input type="hidden" th:id="'writer-' + ${comment.id}" th:value="${comment.user_Id}"/>
                <!-- 수정폼에서 수정 전 값 불러오기 용-->
                <input type="hidden" th:id="'comment-content-' + ${comment.id}" th:value="${comment.content}"/>
                <input type="hidden" th:id="'comment-secret-' + ${comment.id}" th:value="${comment.secret}"/>

                <!-- 수정, 삭제, 답글 등록 버튼-->
                <div sec:authorize="isAuthenticated()" class="d-flex justify-content-start mt-3 gap-2">
                    <button class="btn btn-sm btn-secondary" th:data-comment-index="${comment.id}"
                            onclick="showReplyForm(this.getAttribute('data-comment-index'));">
                        답글 작성
                    </button>
                    <!-- 댓글유저가 삭제안된경우 -->
                    <div th:if="${(comment.users != null) and (!comment.deleted)}">
                        <!-- 관리자거나 댓글 작성자 -->
                        <button class="btn btn-sm btn-secondary"
                                th:if="${(comment.username == #authentication.getPrincipal().getUsername())
                                    or (#authentication.principal.username eq 'admin')}"
                                th:data-comment-index="${comment.id}"
                                th:text="수정" onclick="showModifyForm(this.getAttribute('data-comment-index'));">
                        </button>
                        <button class="btn btn-sm btn-secondary"
                                th:if="${(comment.username == #authentication.getPrincipal().getUsername())
                                    or (#authentication.principal.username eq 'admin')}"
                                th:data-comment-index="${comment.id}"
                                th:text="삭제"
                                onclick="if (confirm('해당 댓글을 삭제하시겠습니까?')) deleteComment(this.getAttribute('data-comment-index'));">
                        </button>
                    </div>
                    <div th:if="${(comment.users == null) and (!comment.deleted)}">
                        <button class="btn btn-sm btn-secondary"
                                th:if="${ (#authentication.principal.username eq 'admin')}"
                                th:data-comment-index="${comment.id}"
                                th:text="수정" onclick="showModifyForm(this.getAttribute('data-comment-index'));">
                        </button>
                        <button class="btn btn-sm btn-secondary"
                                th:if="${#authentication.principal.username eq 'admin'}"
                                th:data-comment-index="${comment.id}"
                                th:text="삭제"
                                onclick="if (confirm('해당 댓글을 삭제하시겠습니까?')) deleteComment(this.getAttribute('data-comment-index'));">
                        </button>
                    </div>

                </div>
                <div th:if="${!comment.deleted}">
                    <a sec:authorize="isAnonymous()" class="btn btn-sm btn-outline-secondary" th:href="@{/users/login}">
                        추천(로그인필요)
                        <span class="badge rounded-pill bg-success" th:text="${#sets.size(comment.recommends)}"></span>
                    </a>
                    <!-- 로그인한 경우 -->
                    <form sec:authorize="isAuthenticated()" th:action="@{|/comment/${comment.id}/recommend|}" method="post">
                        <button type="submit" class="recommend btn btn-sm btn-outline-secondary">
                            추천
                            <span class="badge rounded-pill bg-success" th:text="${#sets.size(comment.recommends)}"></span>
                        </button>
                    </form>
                </div>
                <div th:if="${!comment.deleted}">
                    <a sec:authorize="isAnonymous()" class="btn btn-sm btn-outline-secondary" th:href="@{/users/login}">
                        비추천(로그인필요)
                        <span class="badge rounded-pill bg-success" th:text="${#sets.size(comment.notRecommends)}"></span>
                    </a>
                    <!-- 로그인한 경우 -->
                    <form sec:authorize="isAuthenticated()" th:action="@{|/comment/${comment.id}/notrecommend|}" method="post">
                        <button type="submit" class="recommend btn btn-sm btn-outline-secondary">
                            비추천
                            <span class="badge rounded-pill bg-success" th:text="${#sets.size(comment.notRecommends)}"></span>
                        </button>
                    </form>
                </div>
            </div>
        </div>
        <!-- 답글 버튼 클릭 -->
        <div th:id="'reply-form-' + ${comment.id}" class="d-flex flex-column gap-2 visually-hidden" style="margin : 10px">
                <textarea placeholder="답글을 입력해주세요." th:id="'replyCommentContents-' + ${comment.id}"  style="height: 50px"
                          class="border border-gray-300 rounded-lg textarea-lg flex-grow-1 focus:ring-blue-400"></textarea>
            첨부파일 : <input type="file" th:id="'reply-comment-file' + ${comment.id}"> <br><br>

            <div class="d-flex justify-content-start">
                <label class="label gap-2" style="cursor:pointer;" th:if="${comment.SecretNumber != 0 || !comment.secret}">
                    <i class="fa-solid fa-lock"></i>
                    <span class="label-text font-semibold">비밀댓글</span>
                    <input type="checkbox" th:id="'replySecret-' + ${comment.id}"
                           class="toggle toggle-primary"/>
                </label>
                <label class="label gap-2" style="cursor:pointer;" th:if="${comment.SecretNumber != 0 && comment.secret}">
                    <i class="fa-solid fa-lock"></i>
                    <span class="label-text font-semibold">비밀댓글</span>
                    <input type="checkbox" th:id="'replySecret-' + ${comment.id}"
                           class="toggle toggle-primary"/>
                </label>
                <label th:if="${comment.SecretNumber == 0 && comment.secret}">
                    <input type="hidden" th:id="'replySecret-' + ${comment.id}"
                           class="toggle toggle-primary"/>
                </label>
            </div>
            <button id="reply-comment-write-btn" th:data-comment-index="${comment.id}"
                    onclick="replyCommentWrite(this.getAttribute('data-comment-index'))"
                    class="btn btn-sm mb-3 btn-secondary" style="width:6%">답글작성
            </button>
        </div>

        <!-- 댓글 수정 버튼 클릭 -->
        <div th:id="'modify-form-' + ${comment.id}" class="d-flex flex-column gap-2 visually-hidden" style="margin:10px;">
            <input type="hidden" th:id="'modify-comment-' + ${comment.id}" th:value="${comment.id}"/>
            <input type="hidden" th:id="'modify-writer-' + ${comment.id}" th:value="${comment.user_Id}"/>
            <textarea placeholder="수정할 내용을 입력해주세요" th:id="'modify-comment-contents-' + ${comment.id}"
                      class="ml-2 flex-grow-1"></textarea>
            <div class="d-flex">
                <label class="label gap-2 form-check form-switch" style="cursor:pointer;">
                    <input type="checkbox" th:id="'modify-secret-' + ${comment.id}" class="form-check-input"/>
                    <i class="fa-solid fa-lock"></i>
                    <span class="label-text font-semibold">비밀댓글</span>
                </label>
            </div>
            <br>
            <div th:if="${comment.commentImage != null}">
                <input type="hidden" th:id="'modify-file-comment-' + ${comment.commentImage.getId()}" th:value="${comment.id}"/>
                <input type="hidden" th:id="'modify-file-' + ${comment.commentImage.getId()}" th:value="${comment.commentImage.getId()}"/>
                <button th:id="'file-delete-' + ${comment.commentImage.getId()}" th:data-file-index="${comment.commentImage.getId()}"
                        onclick="fileDelete(this.getAttribute('data-file-index'))"
                   class="btn btn-danger">파일삭제</button>
            </div>
            <br>
            첨부파일 : <input type="file" th:id="'modify-file'+${comment.id}"> <br><br>
            <button id="modify-comment-write-btn" th:data-comment-index="${comment.id}"
                    onclick="modifyCommentWrite(this.getAttribute('data-comment-index'))"
                    class="btn btn-sm mb-3 btn-secondary" style="width:6%">댓글수정
            </button>
        </div>

        <!-- 대댓글 출력-->

        <div class="ml-8 space-y-2">
            <div th:each="childComment, childIndex : ${comment.children}">
                <div class="p-4">
                    <div class="card-body bg-white rounded shadow-lg">
                        <a th:id="|comment_${childComment.id}|"></a>
                        <div th:if="${(childComment.getUsers() != null) and
                                    (childComment.getUsers().getImage() != null)}">
                            <img class="d-flex mr-3 rounded-circle"
                                 th:src="${childComment.getUsers().getImage().getUrl()}" alt="User image" width="50">
                        </div>
                        <div class="d-flex align-items-baseline gap-2">
                            <p th:if="${childComment.users != null}"
                                    th:text="${childComment.users.nickname}" class="text-primary"></p>
                            <p th:if="${childComment.users == null and childComment.delete_user_nickname !=null
                                and childComment.delete_user_id != null}">
                                [[${childComment.delete_user_nickname}]] (소프트삭제유저)
                            </p>
                            <p th:if="${(childComment.users ==null) and (childComment.delete_user_id ==null)}">
                                [[${childComment.delete_user_nickname}]] (완전 탈퇴한 유저입니다).
                            </p>
                            <!-- 비밀댓글 표시 자물쇠-->
                            <span class="badge text-bg-success" th:if="${childComment.secret}">
                            <i class="fa-solid fa-lock" style="color: #ffffff;"></i>
                        </span>
                        </div>
                        <div th:if="${childComment.getImage() != null}">
                                <img th:src="${childComment.getImage().getUrl()}" alt="Image" width="200px" height="200px">
                        </div>
                        <div class="d-flex justify-content-between">
                            <p th:text="${childComment.content}" style="white-space: pre-wrap;" th:if="${!childComment.deleted and !childComment.secret}"></p>

                            <p class="text-body-tertiary" th:if="${childComment.deleted}"> 삭제된 댓글입니다.</p>
                            <!-- 비밀 댓글 분기 시작, 위 : 로그인 시 대댓글 작성자 or 댓글 작성자 or 질문 작성자 or 관리자일 경우 확인 가능 / 아래 : 로그인 안하면 아에 안보이게-->
                            <div sec:authorize="isAuthenticated()" th:if="${childComment.secret}">
                                <div th:if="${childComment.users != null}">
                                    <p class="text-lg font-bold"
                                       th:if="${(childComment.users.username == #authentication.getPrincipal().getUsername())
                                 or (comment.username == #authentication.getPrincipal().getUsername()) or
                                 (board.username == #authentication.getPrincipal().getUsername()) or
                                 (#authentication.principal.username eq 'admin')}"
                                       th:text="${childComment.content}"></p>
                                    <p class="text-lg font-bold"
                                       th:if="${!((childComment.users.username == #authentication.getPrincipal().getUsername()) or
                                   (comment.username == #authentication.getPrincipal().getUsername()) or
                                   (board.username == #authentication.getPrincipal().getUsername()) or
                                    (#authentication.principal.username eq 'admin'))}">
                                        비밀 댓글입니다.</p>
                                </div>
                                <div th:if="${childComment.users == null}">
                                    <p class="text-lg font-bold"
                                       th:if="${(comment.username == #authentication.getPrincipal().getUsername()) or
                                 (board.username == #authentication.getPrincipal().getUsername()) or
                                 (#authentication.principal.username eq 'admin')}"
                                       th:text="${childComment.content}"></p>
                                    <p class="text-lg font-bold"
                                       th:if="${!((comment.username == #authentication.getPrincipal().getUsername()) or
                                   (board.username == #authentication.getPrincipal().getUsername()) or
                                    (#authentication.principal.username eq 'admin'))}">
                                        비밀 댓글입니다.</p>
                                </div>
                            </div>
                            <div sec:authorize="isAnonymous()" th:if="${childComment.secret}">
                                <p class="text-lg font-bold">
                                    비밀 댓글입니다.</p>
                            </div>
                            <!-- 비밀 댓글 분기 끝 -->
                            <!-- 댓글 우측 작성, 수정일 시작-->
                            <div class="gap-3">
                                <div class="badge bg-light text-dark p-2 text-start gap-3">
                                    작성일
                                    <div th:text="${#temporals.format(childComment.createDate, 'yyyy-MM-dd HH:mm')}"></div>
                                </div>
                                <div th:if="${childComment.modifyDate != null}" class="badge bg-light text-dark p-2 text-start gap-3">
                                    <i class="fa-solid fa-clock-rotate-left"></i>
                                    수정일
                                    <div th:text="${#temporals.format(childComment.modifyDate, 'yyyy-MM-dd HH:mm')}"></div>
                                </div>
                            </div>
                        </div>
                        <!-- 답글 삭제, 수정시 답글 정보 -->
                        <input type="hidden" th:id="'modify-reply-comment-' + ${childComment.id}"
                               th:value="${childComment.id}"/>
                        <input type="hidden" th:if="${childComment.users != null}"
                               th:id="'modify-reply-writer-' + ${childComment.id}"
                               th:value="${childComment.users.id}"/>
                        <input type="hidden" th:if="${childComment.users == null}"
                               th:id="'modify-reply-writer-' + ${childComment.id}"
                               th:value="0"/>
                        <!-- 수정폼에서 수정 전 값 불러오기 용-->
                        <input type="hidden" th:id="'child-comment-content-' + ${childComment.id}"
                               th:value="${childComment.content}"/>
                        <input type="hidden" th:id="'child-comment-secret-' + ${childComment.id}"
                               th:value="${childComment.secret}"/>
                        <!-- 답글(대댓글) 수정, 삭제 버튼-->
                        <div sec:authorize="isAuthenticated()" class="d-flex justify-content-start mt-3 gap-2">
                            <div th:if="${(childComment.users !=null) and (!childComment.deleted)}">
                                <button class="btn btn-sm btn-secondary"
                                        th:if="${((#authentication.getPrincipal().getUsername() == childComment.users.username)
                                    or #authentication.principal.username eq 'admin') }"
                                        th:data-child-index="${childComment.id}"
                                        th:text="수정" onclick="showReplyModifyForm(this.getAttribute('data-child-index'));">
                                </button>
                                <button class="btn btn-sm btn-secondary"
                                        th:if="${((#authentication.getPrincipal().getUsername() == childComment.users.username)
                                     or #authentication.principal.username eq 'admin')}"
                                        th:data-comment-index="${childComment.id}"
                                        th:text="삭제"  onclick="if (confirm('해당 댓글을 삭제하시겠습니까?'))
                                         deleteReplyComment(this.getAttribute('data-comment-index'));">
                                </button>
                            </div>
                            <div th:if="${(childComment.users ==null) and (!childComment.deleted)}">
                                <button class="btn btn-sm btn-secondary"
                                        th:if="${ #authentication.principal.username eq 'admin'}"
                                        th:data-child-index="${childComment.id}"
                                        th:text="수정" onclick="showReplyModifyForm(this.getAttribute('data-child-index'));">
                                </button>
                                <button class="btn btn-sm btn-secondary"
                                        th:if="${ #authentication.principal.username eq 'admin'}"
                                        th:data-comment-index="${childComment.id}"
                                        th:text="삭제"  onclick="if (confirm('해당 댓글을 삭제하시겠습니까?'))
                                         deleteReplyComment(this.getAttribute('data-comment-index'));">
                                </button>
                            </div>

                        </div>
                        <div>
                            <a sec:authorize="isAnonymous()" class="btn btn-sm btn-outline-secondary" th:href="@{/users/login}">
                                추천(로그인필요)
                                <span class="badge rounded-pill bg-success" th:text="${#sets.size(childComment.getRecommends())}"></span>
                            </a>
                            <!-- 로그인한 경우 -->
                            <form sec:authorize="isAuthenticated()" th:action="@{|/comment/${childComment.id}/recommend|}" method="post">
                                <button type="submit" class="recommend btn btn-sm btn-outline-secondary">
                                    추천
                                    <span class="badge rounded-pill bg-success" th:text="${#sets.size(childComment.getRecommends())}"></span>
                                </button>
                            </form>
                        </div>
                        <div>
                            <a sec:authorize="isAnonymous()" class="btn btn-sm btn-outline-secondary" th:href="@{/users/login}">
                                비추천(로그인필요)
                                <span class="badge rounded-pill bg-success" th:text="${#sets.size(childComment.getNot_recommends())}"></span>
                            </a>
                            <!-- 로그인한 경우 -->
                            <form sec:authorize="isAuthenticated()" th:action="@{|/comment/${childComment.id}/notrecommend|}" method="post">
                                <button type="submit" class="recommend btn btn-sm btn-outline-secondary">
                                    비추천
                                    <span class="badge rounded-pill bg-success" th:text="${#sets.size(childComment.getNot_recommends())}"></span>
                                </button>
                            </form>
                        </div>
                    </div>
                    <!-- 답글(대댓글) 수정 버튼 클릭시 나타날 폼 -->
                    <div th:id="'modify-reply-form-' + ${childComment.id}" class="d-flex flex-column gap-2 visually-hidden" style="margin:10px;">
                    <textarea placeholder="수정할 내용을 입력해주세요"
                              th:id="'modify-reply-comment-contents-'
                                               + ${childComment.id}"  class="ml-2 flex-grow-1"></textarea>
                        <div class="d-flex">
                            <label class="label gap-2" style="cursor:pointer;" th:if="${comment.SecretNumber != 0 || !comment.secret}">
                                <input type="checkbox" th:id="'modify-reply-secret-' + ${childComment.id}" class="form-check-input"/>
                                <i class="fa-solid fa-lock"></i>
                                <span class="label-text font-semibold">비밀댓글</span>
                            </label>
                            <label class="label gap-2" style="cursor:pointer;"
                                   th:if="${comment.SecretNumber != 0 && comment.secret}">
                                <input type="checkbox" th:id="'modify-reply-secret-' + ${childComment.id}" class="form-check-input"/>
                                <i class="fa-solid fa-lock"></i>
                                <span class="label-text font-semibold">비밀댓글</span>
                            </label>
                            <label th:if="${comment.SecretNumber == 0 && comment.secret}">
                                <input type="hidden" th:id="'modify-reply-secret-' + ${childComment.id}"
                                       class="form-check-input"/>
                            </label>
                        </div>
                        <div th:if="${childComment.getImage() != null}">
                            <input type="hidden" th:id="'modify-file-comment-' + ${childComment.getImage().getId()}" th:value="${childComment.id}"/>
                            <input type="hidden" th:id="'modify-file-' + ${childComment.getImage().getId()}" th:value="${childComment.getImage().getId()}"/>
                            <button th:id="'reply-file-delete-' + ${childComment.getImage().getId()}"
                                    th:data-file-index="${childComment.getImage().getId()}"
                                    th:onclick="fileDelete(this.getAttribute('data-file-index'))"
                                    class="btn btn-danger">파일삭제</button>
                        </div>
                        <br>
                        첨부파일 : <input type="file" th:id="'reply-modify-file'+${childComment.id}"> <br><br>
                        <button id="modify-reply-comment-write-btn" th:data-child-index="${childComment.id}"
                                onclick="modifyReplyCommentWrite(this.getAttribute('data-child-index'))"
                                class="btn btn-sm mb-3 btn-secondary" style="width:6%">댓글수정
                        </button>
                    </div>
                </div>

            </div>

        </div>
    </div>

    <!-- 페이징처리 시작 -->
    <div th:if="${!boardCommentPaging.isEmpty()}">
        <ul class="pagination justify-content-center">
            <input type="hidden" name="boardCommentPaging_number" th:value="${boardCommentPaging.number}">
            <li class="page-item" th:classappend="${!boardCommentPaging.hasPrevious} ? 'disabled'">
                <a class="page-link"
                   th:href="@{|?sort=${sort}&page=${boardCommentPaging.number-1}|}">
                    <span>이전</span>
                </a>
            </li>
            <li th:each="page: ${#numbers.sequence(0, boardCommentPaging.totalPages-1)}"
                th:if="${page >= boardCommentPaging.number-5 and page <= boardCommentPaging.number+5}"
                th:classappend="${page == boardCommentPaging.number} ? 'active'"
                class="page-item">
                <a th:text="${page}" class="page-link" th:href="@{|?sort=${sort}&page=${page}|}"></a>
            </li>
            <li class="page-item" th:classappend="${!boardCommentPaging.hasNext} ? 'disabled'">
                <a class="page-link" th:href="@{|?sort=${sort}&page=${boardCommentPaging.number+1}|}">
                    <span>다음</span>
                </a>
            </li>
        </ul>
    </div>
    <!-- 페이징처리 끝 -->

    <table class="table-PreNext">
        <tr>
            <td width="50px" style="font-weight: bolder">이전글</td>
            <td th:if="${predto != null}">
                <a th:href="@{|/board/detail/${predto.id}|}"
                   th:text="*{predto.title}" class="KOTRA-fontsize-100"></a></td>
            <td th:if="${predto == null}">
                이전글이 없습니다.
            </td>
        </tr>
        <br>
        <tr>
            <td width="50px"  style="font-weight: bolder" >다음글</td>
            <td th:if="${nextdto !=null}">
                <a th:href="@{|/board/detail/${nextdto.id}|}"
                   th:text="*{nextdto.title}"
                   class="KOTRA-fontsize-100"></a></td>
            <td th:if="${nextdto == null}">
                다음글이 없습니다.
            </td>
        </tr>
    </table>


    <script layout:fragment="script" type='text/javascript'>

        const delete_elements = document.getElementsByClassName("delete");
        Array.from(delete_elements).forEach(function(element) {
            element.addEventListener('click', function() {
                if(confirm("정말로 삭제하시겠습니까?")) {
                    location.href = this.dataset.uri;
                };
            });
        });
    </script>
    <script src="/js/comment.js"></script>
</main>
</html>